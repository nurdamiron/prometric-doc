# üîç –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó AUTH –°–ò–°–¢–ï–ú–´

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û

#### 1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Owner**
- ‚úÖ Pre-registration —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ Email verification —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏ –∏–∑ –ë–î
- ‚úÖ Onboarding —Å–æ–∑–¥–∞–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ `selectedRole: 'owner'`
- ‚úÖ –ë–ò–ù –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 12 —Ü–∏—Ñ—Ä)
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è workspace –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ Owner –º–æ–∂–µ—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –ø–æ—Å–ª–µ onboarding

#### 2. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Employee**
- ‚úÖ Pre-registration —Å `organizationBin` –Ω–∞—Ö–æ–¥–∏—Ç –∫–æ–º–ø–∞–Ω–∏—é
- ‚úÖ Email verification —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Onboarding —Å `selectedRole: 'employee'` —Å–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É
- ‚úÖ Employee —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
- ‚úÖ Employee –º–æ–∂–µ—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è (–Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏)

#### 3. **–ü—Ä–æ—Ü–µ—Å—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è**
- ‚úÖ Owner –≤–∏–¥–∏—Ç pending registrations
- ‚úÖ API `/company/pending-registrations` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫
- ‚úÖ –ú–æ–∂–Ω–æ –æ–¥–æ–±—Ä–∏—Ç—å employee —á–µ—Ä–µ–∑ `/company/approve-registration`

### ‚ö†Ô∏è –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

#### 1. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ**
```javascript
// –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Ç endpoint /select-role
// –í—Å–µ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ /onboarding/complete
// selectedRole –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù, –∏–Ω–∞—á–µ –æ—à–∏–±–∫–∞ 400
```

#### 2. **–ë–ò–ù –≤–∞–ª–∏–¥–∞—Ü–∏—è**
```javascript
// –ü–†–û–ë–õ–ï–ú–ê: –ë–ò–ù –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è owner
// –ü—É—Å—Ç–æ–π –ë–ò–ù = –æ—à–∏–±–∫–∞ "Company BIN is required"
// –ë–ò–ù –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º (DB constraint)
// –ë–ò–ù –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 12 —Ü–∏—Ñ—Ä
```

#### 3. **Response —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**
```javascript
// –ü–†–û–ë–õ–ï–ú–ê: –ù–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤
// –ò–Ω–æ–≥–¥–∞ userId –≤ .data.userId
// –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ –≤ .userId
// Departments –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç null –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
```

#### 4. **Security**
```javascript
// –ü–†–û–ë–õ–ï–ú–ê: Employee –º–æ–∂–µ—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –¥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è
// –°—Ç–∞—Ç—É—Å "pending" –Ω–æ —Ç–æ–∫–µ–Ω –≤—ã–¥–∞–µ—Ç—Å—è
// –ù—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ status –≤ middleware
```

## üîß –ö–ê–ö –ò–°–ü–†–ê–í–ò–¢–¨

### 1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã**
```bash
# –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è OWNER:
1. POST /auth/registration/pre-register
2. POST /auth/registration/verify-email
3. POST /auth/registration/onboarding/complete
   {
     "userId": "from-step-1",
     "email": "owner@example.com",
     "selectedRole": "owner",  # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
     "companyName": "Company",
     "companyBin": "123456789012",  # 12 —Ü–∏—Ñ—Ä!
     "companyType": "–¢–û–û",
     "industry": "IT"
   }
```

### 2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–ª—è Employee**
```bash
# –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è EMPLOYEE:
1. POST /auth/registration/pre-register
   {
     "email": "employee@example.com",
     "organizationBin": "123456789012"  # –ë–ò–ù –∫–æ–º–ø–∞–Ω–∏–∏
   }
   
2. POST /auth/registration/verify-email

3. POST /auth/registration/onboarding/complete
   {
     "userId": "from-step-1",
     "email": "employee@example.com",
     "selectedRole": "employee",  # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
     "employeeCompanyBin": "123456789012",
     "position": "Developer"
   }
```

### 3. **Backend —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**
```typescript
// 1. –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è pending employees
if (user.status === 'pending') {
  throw new ForbiddenException('Account pending approval');
}

// 2. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å response —Å—Ç—Ä—É–∫—Ç—É—Ä—É
return {
  success: true,
  data: {
    userId: user.id,  // –í—Å–µ–≥–¥–∞ –≤ data
    // ...
  }
}

// 3. –í–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã –≤–º–µ—Å—Ç–æ null
departments: departments || []
```

## üìã –†–ê–ë–û–ß–ò–ï –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï

### Owner
```json
{
  "email": "owner_fixed_1755891951@prometric.kz",
  "password": "SecureOwner123!",
  "firstName": "–ù—É—Ä–¥–∞—É–ª–µ—Ç",
  "lastName": "–ê—Ö–º–µ—Ç–æ–≤",
  "companyBin": "991755891951"
}
```

### Employee
```json
{
  "email": "employee_fixed_1755891951@prometric.kz",
  "password": "SecureEmployee123!",
  "firstName": "–ê–π–≥–µ—Ä–∏–º",
  "lastName": "–°–º–∞–≥—É–ª–æ–≤–∞",
  "organizationBin": "991755891951"
}
```

## üéØ –§–ò–ù–ê–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–î–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:**
   - –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `selectedRole` –≤ onboarding
   - –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ë–ò–ù—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å `status` –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞

2. **–î–ª—è –±—ç–∫–µ–Ω–¥–∞:**
   - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é pending status
   - –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å response —Å—Ç—Ä—É–∫—Ç—É—Ä—É
   - –£–ª—É—á—à–∏—Ç—å error messages

3. **–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç `test-fixed-flows.sh`
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã –∏–∑ –ë–î
   - –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã (123456, 000000)

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ **—Ä–∞–±–æ—Ç–∞–µ—Ç**, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç:
- –¢–æ—á–Ω–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è API –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–æ—Å–æ–±–µ–Ω–Ω–æ `selectedRole`)
- –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ë–ò–ù–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production: 85%**

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª—è–µ–º—ã –∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è MVP.